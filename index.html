<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trò Chơi Cược Xúc Xắc (Online với Phòng)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Firebase -->
    <script>
        if (typeof __firebase_config === 'undefined') {
          window.__firebase_config = JSON.stringify({
              apiKey: "AIzaSyCUrFw_GAv5bIGfwFfuiwCuBcjaNqFohVs",
              authDomain: "tonghaixucxac.firebaseapp.com",
              projectId: "tonghaixucxac",
              storageBucket: "tonghaixucxac.firebasestorage.app",
              messagingSenderId: "282682257745",
              appId: "1:282682257745:web:b1d53ac3f903d95be8a370",
          });
        }
    </script>
    <style>
        body { font-family: 'Roboto', sans-serif; }
        .room-btn { transition: all 0.2s ease-in-out; }
        .room-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        /* ... các style khác giữ nguyên ... */
    </style>
</head>
<body>
    <!-- ... PHẦN GIAO DIỆN ... -->
    <div id="app-container">
        <!-- ... giữ nguyên phần HTML ... -->
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, collection, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Init ---
        const firebaseConfig = JSON.parse(window.__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- UI Elements ---
        // ... như cũ ...

        // --- App State ---
        let localPlayerName = '';
        let currentRoomId = null;
        let myPlayerIndex = null;
        let gameState = {};
        let lobbyUnsubscribe = null;
        let gameUnsubscribe = null;
        let userId;
        let joinTimeout = null;

        // --- Constants ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'dice-game-2024';
        const roomsCollectionPath = `/artifacts/${appId}/public/data/dice-game-rooms-v3`;

        // ... các function phụ như showNotification, showView, v.v. giữ nguyên ...

        // ----------- SỬA ĐÚNG CHUẨN -----------
        // --- JOIN ROOM ---
        async function joinRoom(roomId) {
            if (!userId) {
                showNotification("Đang xác thực, vui lòng đợi một lát...");
                return;
            }
            const roomRef = doc(db, roomsCollectionPath, `room-${roomId}`);
            try {
                showView(gameView);
                gameRoomId.textContent = roomId;
                gameStatus.textContent = 'Đang tham gia phòng...';

                joinTimeout = setTimeout(() => {
                    if (myPlayerIndex === null) {
                        showNotification("Không thể vào phòng. Vui lòng thử lại!");
                        goToLobby();
                    }
                }, 10000);

                await runTransaction(db, async (transaction) => {
                    const roomDoc = await transaction.get(roomRef);
                    let roomData;
                    if (!roomDoc.exists()) {
                        // Tạo phòng mới
                        roomData = {
                            id: roomId,
                            players: [
                                { id: userId, name: localPlayerName, score: 0, rpsChoice: null, bet: null, wantsRematch: false },
                                null
                            ],
                            playerCount: 1,
                            status: 'waiting',
                        };
                        transaction.set(roomRef, roomData);
                    } else {
                        // Phòng đã có người
                        roomData = roomDoc.data();
                        // Đảm bảo players luôn là mảng 2 phần tử
                        if (roomData.players && !Array.isArray(roomData.players)) {
                            roomData.players = [roomData.players['0'] || null, roomData.players['1'] || null];
                        }
                        if (roomData.playerCount >= 2) throw new Error("Phòng đã đầy!");
                        const emptySlot = roomData.players.findIndex(p => !p);
                        if (emptySlot === -1) throw new Error("Phòng đầy nhưng playerCount không chính xác.");

                        // CHỈ update đúng slot trống, không ghi đè player cũ!
                        transaction.update(roomRef, {
                            [`players.${emptySlot}`]: {
                                id: userId,
                                name: localPlayerName,
                                score: 0,
                                rpsChoice: null,
                                bet: null,
                                wantsRematch: false
                            },
                            playerCount: roomData.playerCount + 1,
                            ...(roomData.playerCount + 1 === 2 ? {status: 'rps'} : {})
                        });
                    }
                });

                if(lobbyUnsubscribe) lobbyUnsubscribe();
                currentRoomId = roomId;
                listenToGame(roomId);

            } catch (e) {
                console.error("Join room failed: ", e);
                showNotification(e.message);
                goToLobby();
            }
        }

        // --- UPDATE TỪNG TRƯỜNG KHI GAME ---
        async function updatePlayerState(key, value) {
            // Không bao giờ update nguyên mảng players!
            const update = {};
            update[`players.${myPlayerIndex}.${key}`] = value;
            await updateDoc(doc(db, roomsCollectionPath, `room-${currentRoomId}`), update);
        }

        // --- RỜI PHÒNG ---
        async function leaveRoom() {
            if (!currentRoomId || !userId) return goToLobby();
            const roomRef = doc(db, roomsCollectionPath, `room-${currentRoomId}`);
            try {
                await runTransaction(db, async (transaction) => {
                    const roomDoc = await transaction.get(roomRef);
                    if (!roomDoc.exists()) return;
                    let playersArray = roomDoc.data().players;
                    if (playersArray && !Array.isArray(playersArray)) {
                        playersArray = [playersArray['0'] || null, playersArray['1'] || null];
                    }
                    const idx = playersArray.findIndex(p => p && p.id === userId);
                    if (idx !== -1) playersArray[idx] = null;
                    const stillPlayers = playersArray.filter(p => p !== null);
                    if (stillPlayers.length === 0) {
                        transaction.delete(roomRef);
                    } else {
                        transaction.update(roomRef, {
                            [`players.${idx}`]: null,
                            playerCount: 1,
                            status: 'waiting'
                        });
                    }
                });
            } catch (error) {
                showNotification("Lỗi khi rời phòng.");
            } finally {
                goToLobby();
            }
        }
        quitGameBtn.addEventListener('click', leaveRoom);

        // --- Các function lắng nghe lobby/game giữ nguyên ---
        // Khi cập nhật trạng thái (status, turn, rps, bet, ...), **luôn update từng trường nhỏ, không set lại mảng players!**

        // ... Các function còn lại bạn có thể giữ nguyên, chỉ cần chắc chắn KHÔNG setDoc/set nguyên mảng players khi update trạng thái game.
    </script>
</body>
</html>
